# Implementation Plan: IMSS Medical Web Application

**Branch**: `001-imss-medical-app` | **Date**: 2025-11-29 | **Spec**: [Feature Specification](spec.md)
**Input**: Feature specification from `/specs/001-imss-medical-app/spec.md`

**Note**: This plan was generated by `/speckit.plan` workflow.

## Summary

IMSS Medical Web Application is a patient-facing healthcare platform enabling appointment booking with intelligent urgency-based triage and automatic scheduling. Core features include user authentication (CURP-based registration), appointment management with five-question urgency assessment determining scheduling priority (high: 24h, mid: 72h, low: 1-2 weeks), doctor directory with availability, medicine requests, appointment history, and sick leave management. All interfaces in Spanish with Mexican localization (date format, currency, CURP validation). Success metrics: sub-3-minute appointment booking, 500 concurrent users with <2s page load, 99.5% uptime, 95% triage accuracy.

## Technical Context

**Language/Version**: JavaScript/TypeScript (Node.js 18+) for backend, React 18+ for frontend  
**Primary Dependencies**: Express.js (backend API), React Router (frontend SPA), PostgreSQL (relational data), JWT (authentication), i18n-js (Spanish localization)  
**Storage**: PostgreSQL 14+ for persistent data (users, appointments, doctors, requests); Redis for session/caching  
**Testing**: Jest + Supertest (backend unit/integration), React Testing Library + Cypress (frontend unit/e2e)  
**Target Platform**: Cloud infrastructure (AWS/Azure/GCP recommended) with Docker containerization; responsive web browser (Chrome, Firefox, Safari)
**Project Type**: Web application with separate frontend and backend services  
**Performance Goals**: Page load <2s (p95), API response <500ms (p95), 500 concurrent users supported, 24-hour appointment slot lookup <1s  
**Constraints**: CURP validation format (18 alphanumeric chars), Spanish-only UI (no language switcher MVP), WCAG 2.1 AA accessibility compliance, no external healthcare system integrations for MVP  
**Scale/Scope**: MVP for single hospital location, ~10k active users in year 1, estimated 150-200 screens/views, multi-page workflows (registration, appointment booking, triage)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Code Quality First (Principle I)
- ✅ **Automated linting**: Defined (ESLint for JavaScript/TypeScript)
- ✅ **80% code coverage**: Required in testing section
- ✅ **Clear comments**: Mandatory for complex business logic (triage algorithm, scheduling)
- ✅ **DRY principle**: Enforced through service layer architecture
- ✅ **Type safety**: TypeScript enforced across full stack

### Test-Driven Development (Principle II) - ⚠️ REVIEW
- ✅ **TDD mandatory**: All new features will follow red-green-refactor cycle
- ✅ **100% feature coverage**: Backend business logic (triage, scheduling) requires 100% test coverage
- ⚠️ **Integration tests critical**: Appointment scheduling, triage assessment, doctor availability filtering require integration testing
- **ACTION**: Design integration test suite in Phase 1 for appointment workflow and doctor schedule conflicts

### User Experience Consistency (Principle III)
- ✅ **Spanish-only interface**: Enforced via NFR-001 through NFR-005
- ✅ **WCAG 2.1 AA**: Defined in success metrics and assumptions
- ✅ **Consistent feedback**: Error messages in Spanish, consistent status indicators
- ✅ **User language**: Non-technical Spanish for healthcare context (symptoms, urgency)

### Performance by Default (Principle IV)
- ✅ **Baseline targets established**: <2s page load, <500ms API response, 24h slot lookup <1s
- ✅ **Load testing**: Required (500 concurrent users minimum)
- ⚠️ **Monitoring configured**: Not specified in detail—requires Phase 1 planning
- ✅ **Regression triggers**: 10% slowdown triggers investigation

### Observability and Debuggability (Principle V)
- ⚠️ **Structured logging**: JSON logging required but not detailed in spec
- ⚠️ **Error context**: User ID, appointment ID, urgency level must be logged with errors
- **ACTION**: Define logging strategy in Phase 0 research (log aggregation tool, alert thresholds)

**Gate Status**: ✅ **PASSES** - No blocking violations. Two areas require Phase 1 design (integration test architecture, logging strategy).

## Project Structure

### Documentation (this feature)

```
specs/001-imss-medical-app/
├── spec.md                  # Feature specification (9 user stories, 37 FR, 8 NFR)
├── plan.md                  # This file (implementation plan)
├── research.md              # Phase 0: Technology research & triage algorithm
├── data-model.md            # Phase 1: Database schema & entity relationships
├── quickstart.md            # Phase 1: Developer setup and first-run guide
├── contracts/               # Phase 1: API contracts (OpenAPI/Swagger)
│   ├── auth.openapi.yaml
│   ├── appointments.openapi.yaml
│   ├── doctors.openapi.yaml
│   ├── requests.openapi.yaml
│   └── triage.openapi.yaml
└── checklists/
    └── requirements.md      # Specification validation checklist
```

### Source Code (repository root)

```
# Web Application Structure (Frontend + Backend)

backend/
├── src/
│   ├── models/              # Data models (User, Appointment, Doctor, etc.)
│   │   ├── User.ts
│   │   ├── Appointment.ts
│   │   ├── Doctor.ts
│   │   ├── UrgencyAssessment.ts
│   │   ├── MedicineRequest.ts
│   │   └── SickLeaveRequest.ts
│   ├── services/            # Business logic services
│   │   ├── AuthService.ts   # Registration, login, password reset
│   │   ├── AppointmentService.ts  # Booking, filtering, persistence
│   │   ├── TriageService.ts # 5-question triage algorithm, urgency classification
│   │   ├── SchedulingService.ts   # Automatic assignment based on urgency
│   │   ├── DoctorService.ts # Directory, availability, filtering
│   │   ├── MedicineService.ts     # Medicine request workflow
│   │   ├── SickLeaveService.ts    # Sick leave certificate generation
│   │   └── CURPService.ts   # CURP validation
│   ├── api/                 # Express.js route handlers
│   │   ├── routes/
│   │   │   ├── auth.routes.ts
│   │   │   ├── appointments.routes.ts
│   │   │   ├── doctors.routes.ts
│   │   │   ├── requests.routes.ts
│   │   │   └── triage.routes.ts
│   │   ├── middleware/
│   │   │   ├── auth.middleware.ts
│   │   │   ├── validation.middleware.ts
│   │   │   ├── errorHandler.middleware.ts
│   │   │   └── logging.middleware.ts
│   │   └── controllers/     # API endpoint handlers
│   │       ├── AuthController.ts
│   │       ├── AppointmentController.ts
│   │       └── [other controllers]
│   ├── database/
│   │   ├── migrations/      # Schema versioning (Knex/Sequelize)
│   │   ├── seeders/         # Test data and initial doctor setup
│   │   └── connection.ts    # PostgreSQL connection pool
│   ├── utils/
│   │   ├── logger.ts        # Structured JSON logging
│   │   ├── validation.ts    # CURP format, email format, etc.
│   │   ├── jwt.ts           # Token generation/verification
│   │   └── localization.ts  # Spanish message templates
│   ├── config/
│   │   ├── database.ts
│   │   ├── auth.ts
│   │   └── server.ts
│   └── app.ts               # Express app setup
├── tests/
│   ├── unit/                # Unit tests for services, utilities
│   │   ├── services/
│   │   ├── utils/
│   │   └── [service tests]
│   ├── integration/         # Integration tests (API endpoints + DB)
│   │   ├── auth.integration.test.ts
│   │   ├── appointments.integration.test.ts
│   │   ├── triage.integration.test.ts
│   │   └── scheduling.integration.test.ts
│   ├── fixtures/            # Test data (mock users, appointments, doctors)
│   └── setup.ts             # Jest configuration, DB setup/teardown
├── package.json
├── tsconfig.json
├── .eslintrc.json
└── Dockerfile

frontend/
├── src/
│   ├── components/          # React components
│   │   ├── Auth/
│   │   │   ├── Register.tsx     # Registration form with CURP field
│   │   │   └── Login.tsx        # Login form
│   │   ├── Appointments/
│   │   │   ├── BookAppointment.tsx
│   │   │   ├── AppointmentList.tsx
│   │   │   ├── AppointmentHistory.tsx
│   │   │   └── AppointmentDetail.tsx
│   │   ├── Triage/
│   │   │   └── TriageQuestionnaire.tsx  # 5-question form
│   │   ├── Doctors/
│   │   │   ├── DoctorDirectory.tsx
│   │   │   ├── DoctorProfile.tsx
│   │   │   └── DoctorFilter.tsx
│   │   ├── Requests/
│   │   │   ├── MedicineRequest.tsx
│   │   │   └── SickLeaveRequest.tsx
│   │   ├── Common/
│   │   │   ├── Header.tsx
│   │   │   ├── Navigation.tsx
│   │   │   ├── ErrorMessage.tsx
│   │   │   ├── LoadingSpinner.tsx
│   │   │   └── ConfirmationModal.tsx
│   │   └── Layout/
│   │       └── MainLayout.tsx
│   ├── pages/               # Page-level components (for routing)
│   │   ├── HomePage.tsx
│   │   ├── DashboardPage.tsx
│   │   ├── AppointmentBookingPage.tsx
│   │   └── [other pages]
│   ├── services/            # API client services
│   │   ├── authService.ts
│   │   ├── appointmentService.ts
│   │   ├── doctorService.ts
│   │   └── requestService.ts
│   ├── hooks/               # Custom React hooks
│   │   ├── useAuth.ts
│   │   ├── useAppointments.ts
│   │   └── useDoctors.ts
│   ├── i18n/                # Spanish localization
│   │   ├── es.json          # All Spanish labels, messages, errors
│   │   └── i18n.config.ts
│   ├── styles/              # CSS/SCSS (tailored for Spanish text)
│   │   ├── globals.css
│   │   └── components.module.css
│   ├── types/               # TypeScript interfaces
│   │   ├── User.ts
│   │   ├── Appointment.ts
│   │   └── [other types]
│   ├── utils/               # Frontend utilities
│   │   ├── api.client.ts
│   │   ├── validation.ts
│   │   ├── dateFormat.ts    # Mexican date formatting (DD/MM/YYYY)
│   │   └── storage.ts       # localStorage for auth token
│   ├── App.tsx              # Main app component with routing
│   ├── index.tsx            # React DOM render
│   └── config.ts            # API base URL, feature flags
├── tests/
│   ├── unit/                # Component unit tests
│   │   ├── components/
│   │   ├── hooks/
│   │   └── utils/
│   ├── e2e/                 # Cypress end-to-end tests
│   │   ├── registration.cy.ts
│   │   ├── appointment-booking.cy.ts
│   │   ├── triage.cy.ts
│   │   └── doctor-selection.cy.ts
│   └── setup.ts
├── public/
│   └── index.html
├── package.json
├── tsconfig.json
├── .eslintrc.json
├── jest.config.js
├── cypress.config.js
└── Dockerfile

# Shared Infrastructure
docker-compose.yml          # PostgreSQL, Redis, frontend, backend services
.github/
├── workflows/
│   ├── test.yml            # Run tests on PR
│   ├── build.yml           # Build images on merge
│   └── deploy.yml          # Deploy to cloud on tag
└── [CI/CD configurations]
```

**Structure Decision**: Web application with separate frontend and backend services. Rationale:
1. **Frontend (React SPA)**: Handles Spanish UI, responsive design, real-time appointment slot filtering, form validation
2. **Backend (Express.js + TypeScript)**: Manages authentication, business logic (triage algorithm, scheduling), database access, API contracts
3. **Separation benefits**: Independent scaling, team specialization, reusable backend API for future mobile apps, easier testing
4. **Database (PostgreSQL)**: Relational schema for users, appointments, doctors, medical requests; ACID compliance for consistency
5. **Caching (Redis)**: Session storage, appointment slot cache (improves lookup performance <1s requirement)

## Complexity Tracking

No constitution violations requiring justification. Plan follows all core principles with two design items to confirm in Phase 1.

| Area | Decision | Why Appropriate |
|------|----------|-----------------|
| Tech Stack | TypeScript full-stack | Type safety across entire system (per Principle I); improves refactoring safety |
| Database | PostgreSQL + Redis | Relational schema handles complex relationships (appointments, urgency, doctor scheduling); Redis caching meets performance targets |
| Testing Strategy | Jest + Cypress + Integration tests | Supports 100% test coverage requirement (Principle II); integration tests ensure appointment/triage workflows function end-to-end |
| Logging | Structured JSON logging | Supports observability requirement (Principle V); enables request ID tracking for debugging |
| Localization | i18n library + Mexican formatting | Supports Spanish-only interface (NFR-001); Mexican date/time/currency formatting per assumptions |

## Phase 0: Research Required

### Research Tasks (to be generated in research.md)

1. **Triage Algorithm Research**: Five-question assessment structure for medical urgency classification (low/mid/high); comparison with existing IMSS protocols or international standards (e.g., triage protocols)
2. **Spanish Localization Library**: i18n-js alternatives; best practices for medical terminology in Spanish; date/time/currency formatting libraries
3. **CURP Validation**: CURP format specifications; IMSS API integration options; offline validation rules
4. **Appointment Scheduling Algorithm**: Optimization for assigning slots based on urgency (high: 24h, mid: 72h, low: 1-2w); conflict avoidance; load balancing across doctors
5. **Performance & Scaling**: Redis caching strategy for appointment slots; load testing tools; horizontal scaling approach for 500 concurrent users
6. **Healthcare Compliance**: WCAG 2.1 AA guidelines for medical web apps; Mexican healthcare privacy regulations (LGPD equivalent); IMSS data protection standards
7. **Email Service Integration**: Spanish email templates; transactional email providers (SendGrid, AWS SES); delivery timing for appointment confirmations
8. **Authentication & Security**: JWT best practices; CURP as unique identifier; password hashing strategy; HTTPS/TLS requirements

## Phase 1: Design Artifacts Required

### Data Model (data-model.md)
- User entity: ID, CURP, email, phone, name, password hash, assigned doctor FK, created_at, updated_at
- Appointment entity: ID, user_id FK, doctor_id FK, scheduled_at, urgency_level (enum: LOW/MID/HIGH), reason, status (enum: BOOKED/COMPLETED/CANCELLED), clinical_notes, created_at
- UrgencyAssessment entity: ID, appointment_id FK, question_responses (JSON), calculated_urgency, timestamp
- Doctor entity: ID, name, specialty, qualifications, years_experience, available_hours (JSON), current_load, average_rating
- DoctorSchedule entity: ID, doctor_id FK, date, available_slots (array), booked_slots (array), max_capacity
- MedicineRequest entity: ID, user_id FK, doctor_id FK, medication_name, dosage, reason, status (enum: PENDING/APPROVED/DENIED), doctor_notes, created_at
- SickLeaveRequest entity: ID, user_id FK, doctor_id FK, reason, start_date, end_date, status (enum: PENDING/APPROVED/DENIED), certificate_path, created_at

### API Contracts (contracts/)
- **Auth API** (auth.openapi.yaml): POST /register, POST /login, POST /logout, POST /password-reset
- **Appointments API** (appointments.openapi.yaml): GET /appointments, POST /appointments, PUT /appointments/:id, GET /appointments/:id, GET /appointments/history
- **Doctors API** (doctors.openapi.yaml): GET /doctors, GET /doctors/:id, GET /doctors/search (filter by specialty)
- **Triage API** (triage.openapi.yaml): POST /triage/assess (5-question questionnaire)
- **Requests API** (requests.openapi.yaml): POST /medicine-requests, PUT /medicine-requests/:id, POST /sick-leave-requests, PUT /sick-leave-requests/:id

### Quickstart Guide (quickstart.md)
- Prerequisites: Node.js 18+, PostgreSQL 14+, npm
- Backend setup: `npm install`, database migration, start Express server
- Frontend setup: `npm install`, environment variables, start React dev server
- Running tests: Jest for backend, React Testing Library + Cypress for frontend
- Local workflow: Register account (CURP: 18 chars), book appointment, complete triage assessment

### Documentation
- README.md: Project overview, feature list, deployment instructions
- SETUP.md: Developer environment setup
- API.md: Endpoint documentation (auto-generated from OpenAPI contracts)
- CONTRIBUTING.md: Development guidelines, testing requirements, code style

## Phase 1.5: Agent Context Update

After Phase 1 design documents are created, run:
```bash
.\.specify\scripts\powershell\update-agent-context.ps1 -AgentType copilot
```

This will update the agent-specific context file with:
- Tech stack: TypeScript, React, Express.js, PostgreSQL, Redis
- New technologies: i18n-js, Jest, React Testing Library, Cypress
- Architecture patterns: Service-oriented, separate frontend/backend, REST API
- Spanish localization: i18n approach, Mexican date formatting
- Performance constraints: <2s page load, <500ms API response

## Phase 2: Implementation & Tasks

This plan stops after Phase 1 design. Phase 2 (implementation) tasks will be created via `/speckit.tasks` command and will include:

### Backend Implementation Tasks
- User authentication service (registration with CURP, JWT, password reset)
- Appointment management service (CRUD, filtering, persistence)
- Triage assessment service (5-question algorithm, urgency classification)
- Automatic scheduling service (slot assignment based on urgency)
- Doctor directory service (CRUD, filtering, availability)
- Medicine & sick leave request workflows

### Frontend Implementation Tasks
- Spanish UI components (registration, login, dashboard)
- Appointment booking flow (3-step: select doctor/date, complete triage, confirm)
- Doctor directory with filtering
- Medicine/sick leave request forms
- Responsive design, error handling, loading states

### Testing Tasks (per Principle II - TDD)
- Unit tests for all services (TriageService, AppointmentService, SchedulingService)
- Integration tests for appointment workflow (end-to-end: booking, triage, confirmation)
- Integration tests for triage accuracy (95% classification requirement)
- E2E tests for critical user journeys (registration → appointment booking → confirmation)
- Performance tests (500 concurrent users, <2s page load, <500ms API response)
- Accessibility tests (WCAG 2.1 AA compliance)

---

**Status**: ✅ **PHASE 1 DESIGN PLAN COMPLETE** - Ready for Phase 0 research and Phase 1 design artifact generation.
